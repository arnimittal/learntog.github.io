<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Connect and Learn together</title>

    <!-- Basic SEO metadata -->
    <meta property="description"
          content="Where Monash Students Connect and Learntogether. Compare timetables at Monash University. and collaborate with friends"/>
    <meta property="keywords" content="Unilyf Monash, Learntog Monash, Compare timetable with friends Monash"/>
    <meta name="copyright" content="_________"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0"/>


    <meta property="og:url" content="https://learntog.github.io/login/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:title" content="Unilyf Monash - Connect and LearnTogether"/>
    <meta property="og:description" content="Where Monash University students connect with each other and learn."/>
    <meta property="og:image" content=""/>
    <!--TODO add the og:image parameter-->


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/css/materialize.min.css">
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/2.6.0/fullcalendar.css'/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">


    <script
            src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>

    <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.1/moment.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/2.6.0/fullcalendar.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/js/materialize.min.js"></script>


    <script src="../js/analytics.js"></script>

    <script>

        function toggleload() {
            $("#calendar").toggleClass("opaque");
        }


        var getdata = {
            setfacebook: function (uid, data) {
                if (typeof data == 'string' && data != null && data != "") {
                    localStorage.setItem(uid + "facebook_friends", data);
                } else if (data != null) {
                    localStorage.setItem(uid + "facebook_friends", JSON.stringify(data));

                }
            },
            getfacebook: function (uid) {
                if (localStorage.getItem(uid + "facebook_friends") != null) {
                    return JSON.parse(localStorage.getItem(uid + "facebook_friends"));
                } else {
                    var starCountRef = firebase.database().ref('users/' + uid + '/facebook_friends/');
                    starCountRef.once('value').then(function (snapshot) {

                        //TODO convert this to list here from dictionary format.
                        var friends = snapshot.val();
                        getdata.setfacebook(uid, friends);
                        return friends;

                    });
                }
            },

            getdatafromdb: function (uid, property) {
                if (property == 'classes') {
                    var starCountRef = firebase.database().ref('users/' + uid + '/classes/');
                    starCountRef.once('value').then(function (snapshot) {

                        var classes = snapshot.val();
                        if (classes != null || classes != undefined) {
                            getdata.setproperty(uid, classes, property);
                            timetablesur = classes;
                            location.reload();
                        } else {
                            alert("Contact us.. quote (that impossible null returned from getdatafromdb)");
                            return null;
                        }
                    });
                }
            },

            isaproperty: function (uid, property) {
                return localStorage.getItem(uid + property) == null || localStorage.getItem(uid + property) == "";
            },
            getproperty: function (uid, property) {

                if (localStorage.getItem(uid + property) != null && JSON.parse(localStorage.getItem(uid + property)) != null) {
                    return JSON.parse(localStorage.getItem(uid + property));
                }
                else {
                    return null;
                }
            },

            setproperty: function (uid, data, property) {
                if (typeof data == 'string' && data != null) {
                    localStorage.setItem(uid + property, data);
                } else {
                    if (data != null) {
                        localStorage.setItem(uid + property, JSON.stringify(data));
                    }
                }
            },

            clearfacebook: function (uid) {
                localStorage.removeItem(uid + 'facebook_friends');

            }

        };

        function thisWeekDay(x) {
            var now = new Date();

            if (x == now.getDay()) {
                return now;
            }

            else if (x < now.getDay()) {
                now.setDate(now.getDate() - (now.getDay() - x));
                return now;
            }
            else if (x > now.getDay()) {
                now.setDate(now.getDate() + (x - now.getDay()));
                return now;
            }

        }

        uid = "";

        weektodays = {Sun: 0, Mon: 1, Tue: 2, Wed: 3, Thu: 4, Fri: 5, Sat: 6};
        function drawoncalendar(timetablesur, whose) {
            if (timetablesur != null && timetablesur.length > 0) {
                unitcolor = {};

                for (i = 0; i < timetablesur.length; i++) {
                    var cl = timetablesur[i];

                    var cld = cl.split("*");

                    var semester2 = cld[cld.length - 1].split("!!")[0].indexOf('1') == -1;


                    if (semester2 || getdata.getproperty("semester1show") || true) {
                        var day = cld[2];
                        var time = cld[3];
                        var hour = time.split(":")[0];
                        var min = time.split(":")[1];


                        var weektoday = {Sun: 0, Mon: 1, Tue: 2, Wed: 3, Thu: 4, Fri: 5, Sat: 6};

                        var start = thisWeekDay(weektoday[day]);

                        start.setHours(hour);
                        start.setMinutes(min);
                        start.setSeconds(0);

                        var unit = cld[0];
                        if (unitcolor['friendstatic'] == null) {
                            unitcolor['friendstatic'] = getRandomColor();
                        }

                        if (whose == "my") {
                            ////////////console.log(unit, unitcolor);
                            if (unitcolor[unit] == null) {
                                unitcolor[unit] = getRandomColor();
                            }
                            createEventCalendarWithTime(unitcolor[unit], start, "---", cld[0], cld[5], timetablesur[i]);
                        } else {
                            $("#"+whose+"color").css('background', unitcolor['friendstatic']);
                            console.log(whose, unitcolor['friendstatic']);
                            createEventCalendarWithTime(unitcolor['friendstatic'], start, whose, cld[0], cld[5], timetablesur[i]);
                        }
                    } else {
                        //non semester 1 class.
                    }

                }
            } else if (whose == 'friend' && (timetablesur == [] || timetablesur.length == 0)) {
                //TODO do a better check here
                alert("Your friend hasn't uploaded their timetable");

            } else {

                loading = document.getElementById("timetableuploadtab");
                loading.style.visibility = "visible";

                document.getElementById("calendarviewtab").style.display = "none";
//                document.getElementById("listviewtab").style.display = "none";

                addfilelist();

                $('ul.tabs').tabs('select_tab', 'timetableupload');

            }

        }
        function WriteText(message, data) {
            message.innerHTML = data;
        }
        function convertToList(dic) {
            var l = [];
            for (var x in dic) {
                l.push(x);
            }
            return l;
        }

        initApp = function () {
            firebase.auth().onAuthStateChanged(function (user) {
                if (user) {

                    var displayName = user.displayName;
                    var email = user.email;
                    var emailVerified = user.emailVerified;
                    var photoURL = user.photoURL;
                    uid = user.uid;

                    user.getIdToken().then(function (accessToken) {

                        uid = user.uid;

                        firebase.database().ref('users/' + uid + "/email").set(email);
                        firebase.database().ref('users/' + uid + "/display_name").set(displayName);
                        firebase.database().ref("id_to_name/" + uid).set(displayName);

                        document.getElementById('useremail').innerHTML = email;
                        document.getElementById('userdisplayname').innerHTML = displayName;

                    });

                    myfriendlookup = {};

                    myfriendlookup = getdata.getproperty(uid, 'myfriendlookup');

                    if (myfriendlookup == null) {
                        //alert to connect to facebook.
                    }

                    ShowFbFriend();

                    myfriends = getdata.getproperty(uid, 'friends');

                    var message = document.getElementById('importantmessage');
                    var alllogin = document.getElementById('logincomponents');
                    if (getdata.isaproperty(uid, "classes")) {

                        var starCountRef = firebase.database().ref('requests/' + uid + '/status');
                        starCountRef.on('value', function (snapshot) {
                            var a = snapshot.val();


                            if (a == null) { //upload,download,success,error
                                ShowSomething(document.getElementById("logincomponents"));
                                drawoncalendar(null, "my");
                            } else if (a != null && a.indexOf("ERR") != -1) {

                                ShowSomething(document.getElementById("logincomponents"));
                                ShowSomething(message);

                                if (a == "ERRORLINE") {
                                    WriteText(message, "Please select all weeks and reupload your timetable file.");
                                } else {
                                    alert("Error: Contact Us \n" + a);
                                    WriteText(message, "Error occured while processing your timetable, contact us.");
                                }
                                drawoncalendar(null, "my");

                            }
                            else if (a == "UPLOAD") {
                                alert("Uploaded successfully");
                                HideSomething(alllogin);
                                ShowSomething(message);
                                WriteText(message, "Uploaded successfully, will be processed soon.");

                                //TODO add hiding all tabs code
                            }
                            else if (a == "DOWNLOADED") {
                                alert("Your file is currently being proccessed!");
                                HideSomething(alllogin);
                                ShowSomething(message);
                                WriteText(message, "Your file is being processed right now, hang tight..");

                            }
                            else if (a == "SUCCESS") {
                                getdata.getdatafromdb(uid, "classes");
                            }
//
                        });
                    } else {

                        ShowSomething(alllogin);
                        ShowSomething(document.getElementById('calendar'));
                        HideSomething(message);

                        ShowSomething(document.getElementById("calendarviewtab"));
//                        ShowSomething(document.getElementById("listviewtab"));
                        ShowSomething(document.getElementById('calendar'));

                        timetablesur = getdata.getproperty(uid, "classes");
                        timetablesur = convertToList(timetablesur);
                        drawoncalendar(timetablesur, "my");

                        $('ul.tabs').tabs('select_tab', 'calendarviewtab');
                    }

                } else {

                    //User is logged out.
                    //TODO check this more carefully for event listenening.

                    loading = document.getElementById("logincomponents");
                    loading.style.display = "none";
                    loading = document.getElementById("firebaseui-auth-container");
                    loading.style.display = "block";


                    document.getElementById('useremail').innerHTML = "";
                    document.getElementById('userdisplayname').innerHTML = "";

                }
            }, function (error) {
                alert("Error signing in\n" + error);
            });
        };
        window.addEventListener('load', function () {
            initApp()
        });


    </script>


    <script>

        function drawFriendOnCalendar(fuid) {
            toggleload();
            //TODO add read permission denied, val not found check. Pass on null to drawfunction.
            //TODO store the facebook friend -> uid locally.
            if(locallstoredsessionclasses[fuid]==null) {
//                console.log("Friend class not local");
                var starCountRef = firebase.database().ref('facebook_to_id/' + fuid);
                starCountRef.once('value').then(function (snapshot) {

                    var uid_fb_friend = snapshot.val();
                    if (uid_fb_friend != null) {

                        var starCountRef = firebase.database().ref('users/' + uid_fb_friend + '/classes/');
                        starCountRef.once('value').then(function (snapshot) {


                            var friend_tt = snapshot.val();


                            friend_tt = convertToList(friend_tt);


                            locallstoredsessionclasses[fuid] = friend_tt;


                            if (friend_tt != null) {


                                //console.log("/users/" + uid_fb_friend + "/viewedby/" + uid);
                                firebase.database().ref("/users/" + uid_fb_friend + "/viewedby/" + uid).set({time: new Date().toString()});

                                drawoncalendar(friend_tt, fuid);
                            } else {
                                alert("Friend hasn't uplaoded timetable. ");
                            }
                            toggleload();

                        });
                    } else {
                        alert("Facebook friend not in database yet..");
                        toggleload();
                    }

                });
            }else{
//                console.log("local");
                drawoncalendar(locallstoredsessionclasses[fuid], fuid);
                toggleload();
            }
        }

        function elementin(l, e) {
            return e in l;
        }
        function getnondup(units, timetablesur) {
            var o = [];
            for (i = 0; i < units.length; i++) {
                if (!elementin(timetablesur, units[i])) {
                    o.push(units[i]);
                }
            }
            return o;
        }

        function showInfoModal(currentevent) {

            var data = currentevent.data.split("*");

            currentclassselected = currentevent;
            var unit = data[0];
            var type = data[1].replace(/[0-9]/g, '');

//            var starCountRef = firebase.database().ref('seperate_unit_list/' + unit + "/" + type);
//            starCountRef.once('value').then(function (snapshot) {
//
//                var units = snapshot.val();
//
//                if (units != null) {
//                    var i = units.indexOf(currentevent.data);
//                    units.splice(i, 1);
//                }
//
//                var o = units;
//
////                $("#dropdownofswapspossible").innerHTML = "";
////
////                if (o != null && o.length > 0) {
////                    var a = "";
////                    for (i = 0; i < o.length; i++) {
////
////                        if (!elementin(timetablesur, o[i])) {
////
////                            var unitd = o[i].split("*");
////                            //////console.log(unitd);
////                            a += ("<option value='" + units[i] + "'>" + unitd[2] + " " + unitd[3] + "</option>");
////                        }
////                    }
////                    $('select').material_select('destroy');
////                    if (a != "") {
////                        $("#dropdownofswapspossible").html(a);
////                    }
////                    else {
////                        $("#dropdownofswapspossible").html("<option disabled >No swaps available</option>");
////                    }
////
////                } else {
////                    $("#dropdownofswapspossible").html("<option disabled >No swaps available</option>");
////                }
////
////                $('select').material_select();
//
//
//            });


            var mates = currentevent.data;


            //TODO this needs to be optimized (...)
            var starCountRef2 = firebase.database().ref('classes/' + mates + '/users/');
            starCountRef2.once('value').then(function (snapshot) {
                var mates = snapshot.val();
                $("#other_class_friends").html("<p></p>");
                $("#class_fb_friends").html("");

                //console.log(mates);

                if (Object.keys(mates).length >= 1) {

                    //console.log(facebook_name_key, myfriendlookup);
                    for (var user in mates) {
                        if (myfriendlookup != null) {
                            if (user != uid && user in myfriendlookup) {
                                //append to facebook div.

                                $("#class_fb_friends").append("<li class=\"collection-item\">" +
                                        "<a target='_blank' href='//facebook.com/" + myfriendlookup[user] + "'>" + facebook_name_key[myfriendlookup[user]] + "</a>" + "</li>")
                            } else if (user != uid && !(user in myfriendlookup)) {
                                $("#other_class_friends").append("");
                            }
                        } else {
                            //no valid to lookup from on localstorage.

                        }
                    }
                } else {
                    //No one else in the class..
                }
            });

            $('#moreinfodialog').modal('open');

        }

        $(document).ready(function () {
            $('.button-collapse').sideNav({
                        menuWidth: 230,
                        draggable: true
                    }
            );
            $('.collapsible').collapsible();
            $('select').material_select();

            $('.modal').modal({
                dismissible: true,
                opacity: .99,
                inDuration: 300,
                outDuration: 200,
                startingTop: '4%',
                endingTop: '10%',
                ready: function (modal, trigger) {

                },
                complete: function () {
                }
                    }
            );


            try {

                calendar = $('#calendar');
                calendar.fullCalendar({
                    editable: false,
                    handleWindowResize: true,
                    weekends: false,
                    defaultView: 'agendaWeek',
                    contentHeight: 'auto',
                    header: false,
                    minTime: '08:00:00',
                    maxTime: '21:00:00',
                    columnFormat: {
                        week: 'ddd'
                    },
                    allDaySlot: false,
                    displayEventTime: true,
                    eventClick: function (event) {

                        if (event.e == "---") {

                            document.getElementById('eventdescription').innerHTML = event.description;
                            var d = event.start._d;

                            dayindextoday = {1: "Monday", 2: "Tuesday", 3: "Wednesday", 4: "Thursday", 5: "Friday"};
                            //console.log(d + "\t" + d.getDay());
                            document.getElementById('eventtime').innerHTML = dayindextoday[d.getDay()] + "\t" + ("00" + d.getHours().toString()).slice(-2) + ":" + ("00" + d.getMinutes().toString()).slice(-2);

                            currentevent = event;
                            showInfoModal(currentevent);
                        }

                    }
                });
            } catch (err) {
            }

        });

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function createEventCalendarWithTime(color, start, e, title, duration, data) {
            try {
                newEvent = {};
                newEvent.title = title;
                newEvent.description = "";

                newEvent.start = start;

                duration = duration.replace("~", ".");
                newEvent.end = new Date(start.getTime() + (duration * 60 * 60 * 1000));
                newEvent.allDay = false;
                newEvent.color = color;
                newEvent.data = data;
                newEvent.e = e;

                $('#calendar').fullCalendar('renderEvent', newEvent, 'stick');
            } catch (err) {

            }
        }

        function convertvaltolist(dic){
            o = [];
            for (var each in dic){
                o.push(dic[each]);
            }
            return o;
        }
        function getRandomColor() {

            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
//            color = '#ABCDEF'

//            var cols = ['810D00', 'CB1558', 'EC36AF',"#44BABD", "#382C56", "#1A4AAD","#3409A6", "#3848FB"]
            /*
             var cols = ['FFF07C', 'D99AC5', 'F7C59F', 'D6E681', 'C4E7D4', '00A878', '52D1DC', 'DDC4DD', '824C71', '8E9AAF', '6369D1', '4E598C']
             return "#" + cols[getRandomInt(0, cols.length - 1)];
             */
        }


    </script>

    <style>
        header, main, footer {
            padding-left: 230px;
        }

        @media only screen and (max-width: 992px) {
            header, main, footer {
                padding-left: 0;
            }
        }

        .fc-today {
            opacity: 0;
            border: none;
        }

        .opaque {
            opacity: 0.15;
        }

        @media print {
            header{
                display: none;
            }
            #calendar{
                display: block;
            }
            .l8{
                width: 100%;
                float: left
            }
            .l4{
                display: none;
            }
        }

    </style>

</head>
<body>

<div id="fb-root"></div>
<script>
    function logoff() {
        firebase.auth().signOut();
    }

    function removethisguy(id) {

        $("#" + id + "color").css('background', 'white');

        var events = $('#calendar').fullCalendar('clientEvents');
        //console.log(events);
        var todelete = [];
        for (var event in events){
            //console.log(events[event]);
            if(events[event].e != "---" && events[event].e == id){

                $("#calendar").fullCalendar('removeEvents', events[event]._id);
                todelete.push(events[event]._id);
            }//TODO replace null with fid/uid
        }

        //console.log(todelete);



    }
    locallstoredsessionclasses = {};
    function ShowFbFriend() {

        facebook_name_key = getdata.getfacebook(uid);
        var response = convertToList(facebook_name_key);
        //TODO store this data in a differnt format and update my friend lookup here


        //https://stackoverflow.com/questions/34222775/how-to-create-autocomplete-form-with-materializecss
        autocompletefbdata = {};
        fbfriendsnametoid = {};
        if (response != null) {
            //TODO show logout facebook button.
            $("#listfacebookfriends").html("<li class=\"collection-header\"><a><h6 onclick=\"LoadFBUI()\">Connect to facebook</h6></a></li>");
            try {
                for (i = 0; i < response.length; i++) {

                    autocompletefbdata[facebook_name_key[response[i]]] = null;
                    fbfriendsnametoid[facebook_name_key[response[i]]] = response[i];

                    //TODO add a checkbox event change listner to show/hide.
                    $("#listfacebookfriends").append("<li  class='collection-item' style='padding-left: 2px'>" +
                        "<div class='row'style='margin-bottom: 0px'> <div class=\"col s10\"> " +
                        "<input type=\"checkbox\" name='selectedfbfriends' value='"+response[i]+"' class=\"filled-in\" id=\""+response[i]+"cbview\" /> " +
                        "<label class='black-text' for=\"" + response[i] + "cbview\">"+facebook_name_key[response[i]]+"</label> " +
                        "</div><div id='"+response[i]+"color"+"' style='height: 20px' class='col s1'></div></div> </li>");
                    //drawFriendOnCalendar("+response[i]+")
                }



                $('input[name=selectedfbfriends]').change(function(){
                    var facebook_ids = $(this).val().toString();
                   if($(this).is(":checked")){
//                       if(locallstoredsessionclasses[facebook_ids])
                       drawFriendOnCalendar(facebook_ids);
//                       alert($(this).val().toString());
                   }else{
//                       alert(id + "\t is unchecked");
                       removethisguy(facebook_ids);
                   }
                });


            } catch (err) {
            }
        } else {
            //TODO show connect to facebook button.

        }



        $('#autocomplete-input-1').autocomplete({
            data: autocompletefbdata,
            limit: 20,
            onAutocomplete: function (val) {
                //TODO do something with the value

                var fuid = fbfriendsnametoid[val];
                drawFriendOnCalendar(fuid);
                //SET CHECBOX to checked.
                $('#'+ fuid + "cbview").prop('checked', true);

                $("#autocomplete-input-1").val("");
                //TODO rearrage viewing at top
                //TODO prevent same person from being added twice


                alert("Compare with " + val + "?");
            },
            minLength: 1,
        });

    }

    //TODO prevent showing those don't have a timetable. (doesn't matter actually) for facebook friends

    function HideSomething(a) {
        a.style.display = "none";
    }
    function ShowSomething(a) {
        a.style.display = "block";
        a.style.visibility = "visible";
    }
    function sendClassSwapPref() {

        var a = $('option:selected').val();

        var aa = null;
        if (a != null) {
            aa = a.split("*");
            var unit = aa[0];
            var type = aa[1].replace(/[0-9]/g, '');
            var x = [currentclassselected.data, a];
            firebase.database().ref('swaps/' + unit + "/" + type + "/" + uid).set(x);
        }
    }


    function GenerateMyFriendLookup(uidp, facebook_id) {

        var starCountRef = firebase.database().ref('id_to_facebook/' + uidp);
        starCountRef.once('value').then(function (snapshot) {
            var va = snapshot.val();
            if (myfriendlookup == null) {
                myfriendlookup = {};
            }
            myfriendlookup[uidp] = va;
            getdata.setproperty(uid, myfriendlookup, 'myfriendlookup');
            myfriendlookup = getdata.getproperty(uid, 'myfriendlookup');
        });

//        //console.log(uidp, facebook_id);

    }

    function AddFriendsWithFacebook(dic) {

        //TODO refer to facebook data stored locally. :) to get the name.
        //console.log(dic);
        for (var facebook_id in dic) {
            var starCountRef = firebase.database().ref('facebook_to_id/' + facebook_id);
            starCountRef.once('value').then(function (snapshot) {
                var va = snapshot.val();
                //console.log(va + "\t" + facebook_id);
                if (va != null) {
                    firebase.database().ref("/users/" + uid + "/friends/" + va).set("I");
                    GenerateMyFriendLookup(va, facebook_id);
                }
            });
        }

    }
    function LoadFBUI() {
        FB.login(function (response) {
            if (response.authResponse) {
                fuid = response.authResponse.userID;
                firebase.database().ref('facebook_to_id/' + fuid).set(uid);
                firebase.database().ref('id_to_facebook/' + uid).set(fuid);


                //TODO add unique code calendar use.

                FB.api(
                        "/me/friends",
                        function (response) {

                            if (response && !response.error) {

                                //TODO consider changing the storage in here.


                                var cb = response.data;
                                var dic = {};

                                for (var i = 0; i < cb.length; i++) {
                                    dic[cb[i].id] = cb[i].name;
                                }

                                getdata.setfacebook(uid, dic);
                                firebase.database().ref("/users/" + uid + "/facebook_friends").set(dic);

                                AddFriendsWithFacebook(dic);

                                ShowFbFriend();

                            }
                        }
                );
            }
        }, {scope: 'email, user_friends'});
    }
    window.fbAsyncInit = function () {
        FB.init({
            appId: '1913393705562842',
            cookie: true,
            xfbml: true,
            version: 'v2.8'
        });
        FB.AppEvents.logPageView();

    };
    (function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {
            return;
        }
        js = d.createElement(s);
        js.id = id;
        js.src = "//connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));

    uid = 0;


</script>


<header>
    <nav class="blue">

        <ul id="slide-out" class="side-nav fixed">
            <li>
                <div class="userView">

                    <a href="#!user"><img id="profileimage" class="circle" src="profilepicdefault.png"></a>
                    <a href="#!name"><span id="userdisplayname" class="black-text name">  </span></a>
                    <a href="#!email"><span id="useremail" class="black-text email"
                                            style="font-size: 0.8em">  </span></a>
                </div>
            </li>

            <script>
                $(document).ready(function () {
                    $('.modal').modal();
                });

                function showPreviousViews() {

                    var starCountRef = firebase.database().ref('users/' + uid + '/viewedby/');
                    starCountRef.once('value').then(function (snapshot) {
                        //TODO convert uid to names.
                        $('#viewing_recent').html("");
                        var a = snapshot.val();
                        for (var each in a) {
                            try {
                                var t = new Date(a[each].time);
                                var months={0:"January",1:"Feburary",2:"March",3:"April",4:"May",5:"June",6:"July",7:"August",8:"September",9:"October",10:"November",11:"December"};
                                $('#viewing_recent').append("<tr><td>" + facebook_name_key[myfriendlookup[each]] + "</td><td>" + t.getDate()+"\t"+ months[t.getMonth()] + "</td></tr>");
                            } catch (err) {
                            }
                        }
                    });
                    $('#modalsrs').modal('open');
                }

                function clearLocalStorage() {
                    //TODO improve this function a little bit for regular data cleansing.
                    localStorage.clear();
                }

                function setURLembed() {
                    //

                    $('#contactuspage').attr('src', "https://docs.google.com/forms/d/e/1FAIpQLSc0mTqbJ9LJPCO4zskNv4IJJVvtIbG83AxwZkgaQHnjMuA27w/viewform?embedded=true");
                }
            </script>


            <!--TODO disable some links when not logged in-->
            <li><a class="subheader">Actions</a></li>

            <li><a onclick="clearLocalStorage()" href="#"><i class="material-icons">create</i>Edit</a></li>
            <li><a href="#"><i class="material-icons">settings</i>Preferences</a></li>
            <li><a onclick="setURLembed()" href="#modalcontact"><i class="material-icons">drafts</i>Contact Us</a></li>

            <li><a target="_blank" href="https://groups.google.com/forum/#!forum/unilyf-monash"><i
                    class="material-icons">help</i>Help</a></li>
            <li><a onclick="logoff()"><i class="material-icons">close</i>Log off</a></li>


        </ul>


        <div class="nav-wrapper">
            <a href="../" class="brand-logo center">Unilyf Monash</a>
            <ul class="show-on-med-and-down">
                <li><a href="#" data-activates="slide-out" class="button-collapse"><i
                        class="material-icons right">menu</i></a></li>
            </ul>

            <ul class="right hide-on-med-and-down">
                <li><a onclick="showPreviousViews()" href="#"><i class="material-icons">remove_red_eye</i></a></li>
            </ul>

        </div>

    </nav>
</header>


<main>


    <h4 id="importantmessage" style="display: none"></h4>
    <h4 style="display: none" id="firebaseui-auth-container" class="center"><a href="../home.html">Login</a></h4>


    <p></p>
    <div class="row" id="logincomponents" style="visibility: hidden; padding-bottom: 30px;">
        <div class="col s12 m12  l8 x">

            <ul id="tabs-swipe-demo" class="tabs">
                <li class="tab col l3 s4"><a class="active" href="#calendarview" id="calendarviewtab">Calendar View</a>
                </li>

                <li style="visibility: hidden" class="tab col l3 s4"><a href="#timetableupload" id="timetableuploadtab">Timetable
                    Upload</a></li>
            </ul>

            <br>

            <div class="col s12" id="calendarview">

                <div class="col l12 s12 ">
                    <div id='calendar'></div>
                    <div class="row valign-wrapper">
                        <div class="col valign-wrapper s10">
                            <div class="fb-share-button" style="padding: 10px;"
                                 data-href="https://learntog.github.io/"
                                 data-layout="button_count" data-size="large" data-mobile-iframe="true"><a
                                    class="fb-xfbml-parse-ignore" target="_blank"
                                    href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Flearntog.github.io%2F&amp;src=sdkpreparse">Share</a>
                            </div>
                            <div class="fb-send" data-href="https://learntog.github.io/"></div>
                        </div>
                        <div class="col s2">

                        </div>

                    </div>

                </div>
                <div class="col l12 s12 center">

                    <!--TODO add calendar control here-->

                </div>

            </div>


            <script>
                //TODO too many document.ready, merge into one.
                $(document).ready(function () {
                    $('.collapsible').collapsible();
                });
            </script>



            <div class="col s12 " id="timetableupload">

                <!--TODO make sure this progress bar works-->
                <div class="progress">
                    <div id="progressbarupload" class="determinate" style="width: 0%"></div>
                </div>

                <script>
                    function addfilelist() {
                        var dropZone = document.getElementById('dropZone');

                        function upload(file) {
                            if (file.size < 2000000) {
                                var storageRef = firebase.storage().ref();
                                var mountainImagesRef = storageRef.child('usertimetable/' + uid);
                                task = mountainImagesRef.put(file);
                                task.on('state_changed', function (snapshot) {
                                    var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                    document.getElementById('progressbarupload').style.width = "" + progress + '%';

                                    switch (snapshot.state) {
                                        case firebase.storage.TaskState.PAUSED:
                                            break;
                                        case firebase.storage.TaskState.RUNNING:
                                            break;
                                    }
                                }, function (error) {
                                    alert("Couldn't upload \n " + error);
                                }, function () {
                                    firebase.database().ref('requests/' + uid + "").set({status: "UPLOAD"});
                                });
                            } else {
                                alert("Too big..");
                            }
                        }

                        var fileInput = document.getElementById('fileInput');
                        fileInput.addEventListener('change', function (e) {
                            var file = fileInput.files[0];
                            upload(file);

                        });

                        // Get file data on drop
                        dropZone.addEventListener('drop', function (e) {
                            e.stopPropagation();
                            e.preventDefault();
                            var files = e.dataTransfer.files; // Array of all files

                            if (files.length == 1) {
                                var file = files[0];
                                if (file.size < 2000000) {
                                    upload(file);
                                } else {
                                    alert("File too big, contact us.");
                                }
                            } else {
                                alert("Select one file only");
                            }
                        });
                    }

                </script>


                <h3>We need your timetable!</h3>
                <div id="dropZone" style="padding-bottom: 150px; border: solid 2px black" class="center col l12 s12 ">

                    <img class="materialboxed" width="100%" src="allocatehelp.png">

                    <br><br><br><br><br>
                    <input id="fileInput" class="center" size="60" style="opacity: 0.4;" type="file">
                    <br><br><br><br>
                    <p><strong>Or drag and drop here</strong></p>

                </div>

            </div>


            <a href="#moreinfodialog"></a>

            <div id="moreinfodialog" class="modal modal-fixed-footer">
                <div class="modal-content">

                    <h5>Activity Details</h5>
                    <p id="eventdescription">Description</p>
                    <p id="eventtime">Time</p>
                    <div class="row">

                        <div class="col s12 m12 l12 x12">

                            <h5>Facebook Friends</h5>
                            <ul id="class_fb_friends" class="collection with-header">
                                <!--<li class="collection-item"></li>-->
                                <li class="collection-item">No facebook friends</li>
                            </ul>

                            <h6 id="other_friends_counter"></h6>
                            <!--<ul id="other_class_friends" class="collection with-header">-->

                            <!--</ul>-->
                        </div>

                        <!--<br><br><br><br>-->
                        <!--<div class="col s12 m12 l12 x12">-->
                            <!--<h6>Swaps</h6>-->
                            <!--<div class="input-field col s12">-->
                                <!--<select id="dropdownofswapspossible">-->
                                <!--</select>-->


                            <!--</div>-->

                            <!--<a class="right" onclick="sendClassSwapPref()">Save preferences</a>-->

                            <!--<br><br>-->

                        <!--</div>-->

                    </div>


                </div>
                <div class="modal-footer">
                    <a href="#!" class="modal-action modal-close waves-effect btn-flat">Close</a>
                </div>
            </div>
        </div>


        <div class="col s12 m12 l4 x4">
            <br>


            <div class="row">
                <div class="col s12">
                    <div class="row">
                        <div class="input-field col s12">
                            <i class="material-icons prefix">search</i>
                            <input type="text" id="autocomplete-input-1" class="autocomplete">
                            <label for="autocomplete-input-1">Search</label>
                        </div>
                    </div>
                </div>
                <div class="col s11 offset-s1">

                    <ul id="listfacebookfriends" style=" overflow-y: auto; max-height: 700px;"
                        class="collection with-header">
                    </ul>


                </div>
            </div>
        </div>
    </div>
</main>


<div id="modalsrs" class="modal">
    <div class="modal-content">
        <h4>Recently viewed</h4>
        <table id="viewing_recent">
            <thead>
            <tr>
                <td>Who</td>
                <td>When</td>
            </tr>
            </thead>
        </table>

    </div>

</div>

<div id="modalcontact" style="width: 90%;" class="modal">
    <div class="modal-content">

        <iframe id="contactuspage" src=""
                width="100%" height="500" frameborder="0" marginheight="0" marginwidth="0">Loading...
        </iframe>


    </div>

</div>

<script src="https://www.gstatic.com/firebasejs/4.1.1/firebase.js"></script>
<script>
    // Initialize Firebase
    var config = {
        apiKey: "AIzaSyBLA6sDqXwnMX6tJayM4dmYCPRzt5CW91M",
        authDomain: "learntogether-a250b.firebaseapp.com",
        databaseURL: "https://learntogether-a250b.firebaseio.com",
        projectId: "learntogether-a250b",
        storageBucket: "learntogether-a250b.appspot.com",
        messagingSenderId: "3175571907"
    };
    firebase.initializeApp(config);
</script>

</body>
</html>
